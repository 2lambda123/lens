name: Create Repository Dispatch request to lens-ide to publish docs
on:
  push:
    branches:
      - master
  release:
    types:
      - published
jobs:
  issue-publish-docs:
    name: Issue Repository Dispatch to publish docs
    runs-on: ubuntu-latest
    steps:
      - name: Get the branch
        if: contains(github.ref, 'refs/heads/master')
        id: get_branch
        run: echo ::set-output name=BRANCH::master}

      - name: Get the release version
        if: contains(github.ref, 'refs/tags/v') && !github.event.release.prerelease
        id: get_version
        run: echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}

      - name: Dispatch initiating repository event
        run: |
          echo "Branch: ${{ github.event.inputs.branch }}"
          echo "Tag: ${{ github.event.inputs.tag }}"

          curl -X POST https://api.github.com/repos/lensapp/lens-ide/dispatches \
          -H 'Accept: application/vnd.github.everest-preview+json' \
          -u ${{ secrets.GH_TOKEN }} \
          --data '{"event_type": "publish-docs", "client_payload": { "repository": "'"$GITHUB_REPOSITORY"'", "branch": "'"${{ steps.get_branch.outputs.BRANCH }}"'", "tag": "'"${{ steps.get_version.outputs.VERSION }}"'" }}'
